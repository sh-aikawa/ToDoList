<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout :: head(表示)}"></head>
<script>
    window.addEventListener("DOMContentLoaded", function () {
        let display_moji = document.getElementById("display");
        let enter_date = document.getElementById("date");
        let push = document.getElementById("item");
        const bgUrl = localStorage.getItem("bgImage");
        document.body.style.backgroundImage = `url('${bgUrl}')`;
        push.addEventListener("click", function (event) {
            if (!enter_date.value) {
                event.preventDefault();
                display_moji.innerHTML = "数字を入力してください！";
                display_moji.style.color = "#ED1A3D";
            }
        });
    });

    function updateCheckedStatus(checkbox) {
        const taskId = checkbox.getAttribute("data-task-id");
        const checked = checkbox.checked;

        const token = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        fetch("/todolist/check", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [header]: token
            },
            body: `taskId=${taskId}&checked=${checked}`,
        }).then((response) => {
            if (response.ok) {
                // 更新成功時の処理
                window.location.reload(); // ページをリロードして更新を反映
            } else {
                // 更新失敗時の処理
                console.error(`Failed to update task ${taskId}.`);
            }
            if (!response.ok) {
                alert("更新に失敗しました");
            }
        });
    }
</script>

<body>
    <div class="back"></div>
    <div th:replace="~{layout :: header}"></div>
    <h3 id="display">toDoリストへようこそ！</h3>

    <h4>toDO絞り込み</h4><a href="/comet/">Comet</a>
    <div id="searchArea">
        <form th:action="@{/todolist/search}" method="post">
            <input type="date" id="date" name="selectedDate" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" min="2000-01-01" max="9999-12-31" />
            <button type="submit" id="item">検索</button>
        </form>
    </div>

    <h3>やることリスト</h3>
    <!-- <form action="/todolist/finish" method="post"><button type="submit">履歴</button></form> -->
    <div id="listArea">
        <table border="1" class="list">
            <tr>
                <th>チェック</th>
                <th>タイトル</th>
                <th>期限</th>
            </tr>
            <tr th:each="task : ${tasks}">
                <th><input type="checkbox" th:attr="data-task-id=${task.taskId}" th:checked="${task.checked}"
                        onchange="updateCheckedStatus(this)" /></th>
                <th><a th:href="@{/todolist/detail(taskId=${task.taskId})}"><span
                            th:text="${task.title}">TodoListをつくる</span></a></th>
                <th><span th:text="${task.limitDate}">2025/6/5</span></th>
            </tr>
        </table>
    </div>
    <div th:replace="~{layout :: footer}"></div>
</body>

</html>